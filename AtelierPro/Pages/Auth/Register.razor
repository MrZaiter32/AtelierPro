@page "/auth/register"
@using System.ComponentModel.DataAnnotations
@using AtelierPro.Services
@attribute [AllowAnonymous]
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject BusyService BusyService

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary">
                    <h3 class="text-white mb-0">Crear Cuenta</h3>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show">
                            @ErrorMessage
                            <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty"></button>
                        </div>
                    }

                    <EditForm Model="@registro" OnValidSubmit="@HandleRegister">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label for="nombreCompleto" class="form-label">Nombre Completo</label>
                            <InputText id="nombreCompleto" class="form-control" placeholder="Juan Pérez"
                                       @bind-Value="registro.NombreCompleto" />
                            <ValidationMessage For="() => registro.NombreCompleto" />
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Correo Electrónico</label>
                            <InputText id="email" type="email" class="form-control" placeholder="usuario@ejemplo.com"
                                       @bind-Value="registro.Email" />
                            <ValidationMessage For="() => registro.Email" />
                        </div>

                        <div class="mb-3">
                            <label for="telefono" class="form-label">Teléfono (Opcional)</label>
                            <InputText id="telefono" class="form-control" placeholder="+58 (xxx) xxx-xxxx"
                                       @bind-Value="registro.Telefono" />
                            <ValidationMessage For="() => registro.Telefono" />
                        </div>

                        <div class="mb-3">
                            <label for="direccion" class="form-label">Dirección (Opcional)</label>
                            <InputText id="direccion" class="form-control" placeholder="Calle Principal 123"
                                       @bind-Value="registro.Direccion" />
                            <ValidationMessage For="() => registro.Direccion" />
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Contraseña</label>
                            <InputText id="password" type="password" class="form-control" 
                                       placeholder="Mínimo 8 caracteres"
                                       @bind-Value="registro.Contraseña" />
                            <ValidationMessage For="() => registro.Contraseña" />
                            <small class="text-muted d-block mt-1">
                                La contraseña debe contener: 8+ caracteres, mayúscula, minúscula, número
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirmar Contraseña</label>
                            <InputText id="confirmPassword" type="password" class="form-control"
                                       placeholder="Repite tu contraseña"
                                       @bind-Value="registro.ConfirmarContraseña" />
                            <ValidationMessage For="() => registro.ConfirmarContraseña" />
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-2" disabled="@IsLoading">
                            @if (IsLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Registrando...</span>
                            }
                            else
                            {
                                <span>Crear Cuenta</span>
                            }
                        </button>
                    </EditForm>

                    <hr />

                    <p class="text-center mb-0">
                        ¿Ya tienes cuenta? 
                        <a href="/auth/login" class="text-decoration-none">Inicia sesión aquí</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private RegistroModelo registro = new();
    private string ErrorMessage = string.Empty;
    private bool IsLoading = false;

    private async Task HandleRegister()
    {
        IsLoading = true;
        ErrorMessage = string.Empty;

        try
        {
            using (BusyService.Start("Registrando usuario..."))
            {
                // Validar que las contraseñas coincidan
                if (registro.Contraseña != registro.ConfirmarContraseña)
                {
                    ErrorMessage = "Las contraseñas no coinciden.";
                    IsLoading = false;
                    return;
                }

                // Registrar usuario
                var (exitoso, mensaje) = await AuthService.RegistrarUsuarioAsync(
                    registro.Email,
                    registro.Contraseña,
                    registro.NombreCompleto,
                    registro.Telefono,
                    registro.Direccion
                );

                if (exitoso)
                {
                    // Redirigir al login con mensaje de éxito (opcional: usar parametro de query)
                    NavigationManager.NavigateTo("/auth/login");
                }
                else
                {
                    ErrorMessage = mensaje ?? "Ocurrió un error durante el registro. Por favor intenta de nuevo.";
                    IsLoading = false;
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error inesperado: {ex.Message}";
            IsLoading = false;
        }
    }

    // Modelo de validación para el registro
    public class RegistroModelo
    {
        [Required(ErrorMessage = "El nombre completo es requerido")]
        [StringLength(100, MinimumLength = 3, 
            ErrorMessage = "El nombre debe tener entre 3 y 100 caracteres")]
        public string NombreCompleto { get; set; } = string.Empty;

        [Required(ErrorMessage = "El correo es requerido")]
        [EmailAddress(ErrorMessage = "Correo inválido")]
        public string Email { get; set; } = string.Empty;

        [Phone(ErrorMessage = "Teléfono inválido")]
        public string? Telefono { get; set; }

        [StringLength(200)]
        public string? Direccion { get; set; }

        [Required(ErrorMessage = "La contraseña es requerida")]
        [StringLength(100, MinimumLength = 8,
            ErrorMessage = "La contraseña debe tener entre 8 y 100 caracteres")]
        public string Contraseña { get; set; } = string.Empty;

        [Required(ErrorMessage = "Debe confirmar la contraseña")]
        public string ConfirmarContraseña { get; set; } = string.Empty;
    }
}