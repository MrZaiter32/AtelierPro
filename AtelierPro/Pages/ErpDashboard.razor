@page "/erp"
@inject ErpDataService DataService

<h3 class="mb-4">ERP Taller y Siniestros V3.0</h3>

@if (_kpis is null)
{
    <p>Cargando métricas...</p>
}
else
{
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted text-uppercase small">Margen Promedio</div>
                    <div class="display-6">@_kpis.MargenPromedio.ToString("C")</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted text-uppercase small">NPS</div>
                    <div class="display-6">@_kpis.Nps.ToString("F0")</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted text-uppercase small">Cycle Time</div>
                    <div class="display-6">@_kpis.CycleTimePromedioDias.ToString("F1") d</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted text-uppercase small">Flujo Caja Proyectado</div>
                    <div class="display-6">@_kpis.FlujoCajaProyectado.ToString("C")</div>
                </div>
            </div>
        </div>
    </div>
}

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">Presupuestos y Workflow</div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Vehículo</th>
                            <th>Estado</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var presupuesto in _presupuestos)
                        {
                            <tr>
                                <td>@presupuesto.Vehiculo?.Version</td>
                                <td><span class="badge bg-secondary">@presupuesto.Estado</span></td>
                                <td>@presupuesto.Total.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">CRM y Fidelización</div>
            <div class="card-body">
                @foreach (var cliente in _clientes)
                {
                    <div class="mb-3 border-bottom pb-2">
                        <strong>@cliente.Nombre</strong>
                        <div class="text-muted small">@cliente.Historial</div>
                        <div class="small">Preferencias: @cliente.Preferencias</div>
                        <div class="small">NPS: @cliente.Nps | Retención: @((cliente.TasaRetencion * 100).ToString("F0"))%</div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-warning">Inventario y Compras</div>
            <div class="card-body">
                <h6 class="text-muted">Refacciones críticas</h6>
                <ul class="list-group list-group-flush">
                    @foreach (var refaccion in _faltantes)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>@refaccion.Sku</span>
                            <span class="badge bg-danger">Stock: @refaccion.StockActual</span>
                        </li>
                    }
                </ul>
                <div class="mt-3">
                    <h6 class="text-muted">Órdenes de compra</h6>
                    <ul class="list-group list-group-flush">
                        @foreach (var orden in _ordenesCompra)
                        {
                            <li class="list-group-item">
                                <div class="fw-semibold">@orden.Proveedor</div>
                                <div class="small text-muted">@orden.Estado</div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">Operación Taller y Activos</div>
            <div class="card-body">
                <h6 class="text-muted">Órdenes de reparación activas</h6>
                <ul class="list-group list-group-flush mb-3">
                    @foreach (var orden in _ordenesReparacion)
                    {
                        <li class="list-group-item">
                            <div class="fw-semibold">@orden.TecnicoAsignado</div>
                            <div class="small text-muted">Horas reales: @orden.HorasReales</div>
                        </li>
                    }
                </ul>
                <h6 class="text-muted">Activos críticos</h6>
                <ul class="list-group list-group-flush">
                    @foreach (var activo in _activos)
                    {
                        <li class="list-group-item">
                            <div class="fw-semibold">@activo.Nombre</div>
                            <div class="small text-muted">Calibración vencida: @(activo.CalibracionVencida ? "Sí" : "No")</div>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">Finanzas y Tesorería</div>
            <div class="card-body">
                <h6 class="text-muted">Facturación</h6>
                <ul class="list-group list-group-flush mb-3">
                    @foreach (var factura in _facturas)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Factura @factura.Id.ToString()[..8]</span>
                            <span>@factura.Importe.ToString("C")</span>
                        </li>
                    }
                </ul>
                <h6 class="text-muted">Flujo de caja</h6>
                <ul class="list-group list-group-flush">
                    @foreach (var transaccion in _transacciones)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>@transaccion.Concepto</span>
                            <span class="@(transaccion.Tipo == "Ingreso" ? "text-success" : "text-danger")">
                                @transaccion.Monto.ToString("C")
                            </span>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private DashboardKpi? _kpis;
    private IEnumerable<Presupuesto> _presupuestos = Enumerable.Empty<Presupuesto>();
    private IEnumerable<Cliente> _clientes = Enumerable.Empty<Cliente>();
    private IEnumerable<Refaccion> _faltantes = Enumerable.Empty<Refaccion>();
    private IEnumerable<OrdenCompra> _ordenesCompra = Enumerable.Empty<OrdenCompra>();
    private IEnumerable<OrdenReparacion> _ordenesReparacion = Enumerable.Empty<OrdenReparacion>();
    private IEnumerable<Activo> _activos = Enumerable.Empty<Activo>();
    private IEnumerable<FacturaCliente> _facturas = Enumerable.Empty<FacturaCliente>();
    private IEnumerable<Transaccion> _transacciones = Enumerable.Empty<Transaccion>();

    protected override void OnInitialized()
    {
        _kpis = DataService.ConstruirKpis();
        _presupuestos = DataService.ObtenerPresupuestos();
        _clientes = DataService.ObtenerClientes();
        _faltantes = DataService.ObtenerFaltantesInventario();
        _ordenesCompra = DataService.ObtenerOrdenesCompra();
        _ordenesReparacion = DataService.ObtenerOrdenesReparacion();
        _activos = DataService.ObtenerActivos();
        _facturas = DataService.ObtenerFacturas();
        _transacciones = DataService.ObtenerTransacciones();
    }
}
