@page "/almacen/cuentos"
@using System.Linq
@using AtelierPro.Models
@using AtelierPro.Services
@using CuentoModel = AtelierPro.Models.CuentoFisico
@inject AlmacenService AlmacenService
@attribute [Authorize(Roles = "Admin,Finanzas,Taller")]

<PageTitle>Cuentos Físicos - AtelierPro</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>
                <span class="oi oi-clipboard"></span>
                Cuentos Físicos
            </h2>
        </div>
    </div>

    @if (cargando)
    {
        <div class="alert alert-info">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Cargando cuentos...
        </div>
    }
    else if (error)
    {
        <div class="alert alert-danger">
            Error al cargar los cuentos físicos. Intenta más tarde.
        </div>
    }
    else if (cuentos == null || cuentos.Count == 0)
    {
        <div class="alert alert-warning">
            No hay cuentos físicos registrados.
        </div>
    }
    else
    {
        <table class="table table-sm table-hover">
            <thead class="table-light">
                <tr>
                    <th>Folio</th>
                    <th>Estado</th>
                    <th>Fecha creación</th>
                    <th>Responsable</th>
                    <th>Detalles</th>
                    <th>Obs.</th>
                </tr>
            </thead>
            <tbody>
                @foreach (CuentoModel cuento in cuentos)
                {
                    var diferencias = cuento.Detalles?.Count(d => d.Diferencia != 0) ?? 0;
                    <tr>
                        <td>@cuento.Id.ToString().Substring(0, 8)</td>
                        <td>
                            @switch (cuento.Estado)
                            {
                                case "Pendiente":
                                    <span class="badge bg-secondary">Pendiente</span>
                                    break;
                                case "EnCurso":
                                    <span class="badge bg-info">En Curso</span>
                                    break;
                                case "Completado":
                                    <span class="badge bg-success">Completado</span>
                                    break;
                                default:
                                    <span class="badge bg-secondary">@cuento.Estado</span>
                                    break;
                            }
                        </td>
                        <td>@cuento.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@(string.IsNullOrEmpty(cuento.ResponsableUsuarioId) ? "-" : cuento.ResponsableUsuarioId)</td>
                        <td>
                            <span class="badge bg-light text-dark">@cuento.Detalles?.Count ?? 0 ítems</span>
                            @if (diferencias > 0)
                            {
                                <span class="badge bg-warning text-dark ms-1">@diferencias ajustes</span>
                            }
                        </td>
                        <td class="text-muted text-truncate" style="max-width:200px;">
                            @(string.IsNullOrEmpty(cuento.Observaciones) ? "-" : cuento.Observaciones)
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<CuentoModel> cuentos = new();
    private bool cargando = true;
    private bool error = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cuentos = (await AlmacenService.ObtenerCuentosFisicosAsync()).ToList();
        }
        catch
        {
            error = true;
        }
        finally
        {
            cargando = false;
        }
    }
}
