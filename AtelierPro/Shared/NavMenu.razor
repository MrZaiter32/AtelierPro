@using Microsoft.AspNetCore.Identity
@using AtelierPro.Data
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager

<MudNavMenu>
    <AuthorizeView>
        <Authorized Context="authContext">
            <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
            <MudNavLink Href="counter" Icon="@Icons.Material.Filled.Add">Counter</MudNavLink>
            <MudNavLink Href="fetchdata" Icon="@Icons.Material.Filled.List">Fetch Data</MudNavLink>

            <MudDivider Class="my-2" />

            <MudNavLink Href="erp" Icon="@Icons.Material.Filled.BusinessCenter">ERP Dashboard</MudNavLink>

            @if (authContext.User.IsInRole("Admin") || authContext.User.IsInRole("Finanzas") || authContext.User.IsInRole("Taller"))
            {
                <MudNavLink Href="presupuestos" Icon="@Icons.Material.Filled.Description">Presupuestos</MudNavLink>
            }

            @if (authContext.User.IsInRole("Admin") || authContext.User.IsInRole("Finanzas") || authContext.User.IsInRole("Cliente"))
            {
                <MudNavLink Href="crm/clientes" Icon="@Icons.Material.Filled.People">Clientes</MudNavLink>
            }

            <MudDivider Class="my-2" />

            @* MÓDULO TALLER *@
            @if (authContext.User.IsInRole("Admin") || authContext.User.IsInRole("Finanzas") || authContext.User.IsInRole("Taller"))
            {
                <MudNavGroup Title="Taller" Icon="@Icons.Material.Filled.Build" Expanded="@ExpandedModules.Contains("taller")">
                    <MudNavLink Href="taller/ordenes" Icon="@Icons.Material.Filled.List">Órdenes de Reparación</MudNavLink>
                    <MudNavLink Href="taller/calendario" Icon="@Icons.Material.Filled.CalendarToday">Calendario</MudNavLink>
                    <MudNavLink Href="taller/tecnicos" Icon="@Icons.Material.Filled.Person">Técnicos</MudNavLink>
                </MudNavGroup>
            }

            @* MÓDULO ALMACÉN *@
            @if (authContext.User.IsInRole("Admin") || authContext.User.IsInRole("Finanzas") || authContext.User.IsInRole("Taller"))
            {
                <MudNavGroup Title="Almacén" Icon="@Icons.Material.Filled.Inventory" Expanded="@ExpandedModules.Contains("almacen")">
                    <MudNavLink Href="almacen/refacciones" Icon="@Icons.Material.Filled.ViewList">Refacciones</MudNavLink>
                    <MudNavLink Href="almacen/movimientos" Icon="@Icons.Material.Filled.ArrowForward">Movimientos</MudNavLink>
                    <MudNavLink Href="almacen/cuentos" Icon="@Icons.Material.Filled.Assignment">Conteos Físicos</MudNavLink>
                    <MudNavLink Href="almacen/alertas" Icon="@Icons.Material.Filled.Warning">Alertas</MudNavLink>
                </MudNavGroup>
            }

            @* MÓDULO COMPRAS *@
            @if (authContext.User.IsInRole("Admin") || authContext.User.IsInRole("Finanzas"))
            {
                <MudNavGroup Title="Compras" Icon="@Icons.Material.Filled.ShoppingCart" Expanded="@ExpandedModules.Contains("compras")">
                    <MudNavLink Href="compras/proveedores" Icon="@Icons.Material.Filled.LocalShipping">Proveedores</MudNavLink>
                    <MudNavLink Href="compras/ordenes" Icon="@Icons.Material.Filled.ShoppingCart">Órdenes de Compra</MudNavLink>
                    <MudNavLink Href="compras/registro" Icon="@Icons.Material.Filled.MenuBook">Requisiciones</MudNavLink>
                    <MudNavLink Href="compras/crear-orden" Icon="@Icons.Material.Filled.Add">Crear Orden</MudNavLink>
                </MudNavGroup>
            }

            @if (authContext.User.IsInRole("Admin"))
            {
                <MudDivider Class="my-2" />
                <MudNavLink Href="admin/usuarios" Icon="@Icons.Material.Filled.AdminPanelSettings">Administración</MudNavLink>
            }
        </Authorized>
        <NotAuthorized>
            <MudNavLink Href="/auth/login" Icon="@Icons.Material.Filled.Login">Iniciar Sesión</MudNavLink>
        </NotAuthorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    private ApplicationUser? CurrentUser;
    private HashSet<string> ExpandedModules = new() { "taller" };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            CurrentUser = await UserManager.FindByEmailAsync(user.Identity.Name ?? string.Empty);
        }
    }
}
